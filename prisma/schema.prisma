generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Cotizacion {
  id_cotizacion       Int                 @id @default(autoincrement())
  codigo_cotizacion   String              @unique @db.VarChar(50)
  id_cliente          Int
  id_vehiculo         Int
  id_usuario          Int
  estado              String              @default("borrador") @db.VarChar(30)
  vigencia_hasta      DateTime
  fecha_aprobacion    DateTime?
  aprobado_por        String?             @db.VarChar(50)
  comentarios_cliente String?
  razon_rechazo       String?
  approval_token      String?             @unique @db.VarChar(255)
  subtotal            Decimal             @db.Decimal(10, 2)
  descuento_global    Decimal             @default(0) @db.Decimal(10, 2)
  impuesto            Decimal             @db.Decimal(10, 2)
  total               Decimal             @db.Decimal(10, 2)
  created_at          DateTime            @default(now())
  updated_at          DateTime            @updatedAt
  comprobantes        Comprobante?
  cliente             Cliente             @relation(fields: [id_cliente], references: [id_cliente])
  usuario             Usuario             @relation(fields: [id_usuario], references: [id_usuario])
  vehiculo            Vehiculo            @relation(fields: [id_vehiculo], references: [id_vehiculo])
  detalle_cotizacion  DetalleCotizacion[]

  @@map("cotizacion")
}

model DetalleCotizacion {
  id_detalle_cotizacion Int        @id @default(autoincrement())
  id_cotizacion         Int
  id_producto           Int?
  cantidad              Int
  precio_unitario       Decimal    @db.Decimal(10, 2)
  descuento             Decimal    @default(0) @db.Decimal(10, 2)
  total                 Decimal    @db.Decimal(10, 2)
  id_servicio           Int?
  servicio_ref          Int?
  cotizacion            Cotizacion @relation(fields: [id_cotizacion], references: [id_cotizacion], onDelete: Cascade)
  producto              Producto?  @relation(fields: [id_producto], references: [id_producto])
  servicio              Servicio?  @relation(fields: [id_servicio], references: [id_servicio])

  @@map("detalle_cotizacion")
}

model Persona {
  id_persona        Int             @id @default(autoincrement())
  nombre            String          @db.VarChar(100)
  apellido_paterno  String          @db.VarChar(100)
  apellido_materno  String?         @db.VarChar(100)
  tipo_documento    TipoDocumento
  numero_documento  String          @unique @db.VarChar(20)
  sexo              String?         @db.VarChar(10)
  telefono          String?         @db.VarChar(15)
  correo            String?         @db.VarChar(100)
  fecha_registro    DateTime        @default(now())
  estatus           Boolean         @default(true)
  registrar_empresa Boolean         @default(false)
  fecha_nacimiento  DateTime?       @db.Date
  nombre_comercial  String?         @db.VarChar(150)
  direccion         String?         @db.VarChar(200)
  cliente           Cliente?
  comprobantes      Comprobante[]
  empresa_persona   EmpresaPersona?
  proveedor         Proveedor?
  trabajador        Trabajador?
  transacciones     Transaccion[]
  usuario           Usuario?

  @@map("persona")
}

model EmpresaPersona {
  id_empresa_persona Int           @id @default(autoincrement())
  persona_id         Int           @unique
  ruc                String        @unique @db.VarChar(11)
  razon_social       String        @db.VarChar(150)
  nombre_comercial   String?       @db.VarChar(100)
  direccion_fiscal   String?       @db.VarChar(200)
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt
  comprobantes       Comprobante[]
  persona            Persona       @relation(fields: [persona_id], references: [id_persona], onDelete: Cascade)

  @@map("empresa_persona")
}

model Cliente {
  id_cliente                Int              @id @default(autoincrement())
  id_persona                Int              @unique
  fecha_registro            DateTime         @default(now())
  estatus                   Boolean          @default(true)
  motivo_override           String?
  override_tipo_comprobante TipoComprobante?
  persona                   Persona          @relation(fields: [id_persona], references: [id_persona], onDelete: Cascade)
  comprobantes              Comprobante[]
  cotizaciones              Cotizacion[]
  mantenimientos            Mantenimiento[]
  vehiculos                 Vehiculo[]

  @@map("cliente")
}

model Proveedor {
  id_proveedor            Int                    @id @default(autoincrement())
  id_persona              Int                    @unique
  razon_social            String                 @db.VarChar(200)
  contacto                String?                @db.VarChar(100)
  numero_contacto         String?                @db.VarChar(15)
  estatus                 Boolean                @default(true)
  compras                 Compra[]
  persona                 Persona                @relation(fields: [id_persona], references: [id_persona], onDelete: Cascade)
  transaccion_proveedores TransaccionProveedor[]

  @@map("proveedor")
}

model Rol {
  id_rol         Int          @id @default(autoincrement())
  nombre_rol     String       @unique @db.VarChar(50)
  estatus        Boolean      @default(true)
  fecha_registro DateTime     @default(now())
  descripcion    String?
  actualizado_en DateTime     @default(now()) @updatedAt
  permisos       RolPermiso[]
  usuarios       Usuario[]

  @@map("rol")
}

model Modulo {
  id_modulo      Int       @id @default(autoincrement())
  clave          String    @unique @db.VarChar(100)
  nombre         String    @db.VarChar(150)
  descripcion    String?
  activo         Boolean   @default(true)
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @default(now()) @updatedAt
  permisos       Permiso[]

  @@map("modulo")
}

model Usuario {
  id_usuario                   Int                      @id @default(autoincrement())
  id_persona                   Int                      @unique
  id_rol                       Int
  nombre_usuario               String                   @unique @db.VarChar(50)
  password                     String                   @db.VarChar(255)
  imagen_usuario               String?
  fecha_creacion               DateTime                 @default(now())
  estado                       Boolean                  @default(true)
  estatus                      Boolean                  @default(true)
  bloqueado_en                 DateTime?
  envio_credenciales_pendiente Boolean                  @default(false)
  motivo_bloqueo               String?
  password_temporal            String?                  @db.VarChar(255)
  password_temporal_expira     DateTime?
  requiere_cambio_password     Boolean                  @default(false)
  ultimo_cambio_password       DateTime?
  ultimo_envio_credenciales    DateTime?
  ultimo_error_envio           String?
  bitacoras                    Bitacora[]
  bitacoras_inventario         BitacoraInventario[]
  compras_registradas          Compra[]
  comprobantes_actualizados    Comprobante[]            @relation("ComprobanteActualizadoPor")
  comprobantes_creados         Comprobante[]            @relation("ComprobanteCreadoPor")
  bitacoras_comprobantes       ComprobanteBitacora[]
  cotizaciones                 Cotizacion[]
  mantenimientos_historial     MantenimientoHistorial[] @relation("MantenimientoHistorialUsuario")
  movimientos_basicos          Movimiento[]
  movimientos_inventario       MovimientoInventario[]
  ordenes_historial            OrdenHistorial[]         @relation("OrdenHistorialUsuario")
  pagos_registrados            Pago[]                   @relation("PagoUsuario")
  permisos_asignados           RolPermiso[]             @relation("RolPermisoAsignado")
  trabajador                   Trabajador?
  entregas_realizadas          Transaccion[]            @relation("EntregaUsuario")
  transacciones                Transaccion[]
  transaccion_vehiculos        TransaccionVehiculo[]
  persona                      Persona                  @relation(fields: [id_persona], references: [id_persona], onDelete: Cascade)
  rol                          Rol                      @relation(fields: [id_rol], references: [id_rol])
  permisos                     UsuarioPermiso[]
  ventas_registradas           VentaPago[]

  // Reportes relations (reverse sides)
  reportTemplates ReportTemplate[]
  reportSchedules ReportSchedule[]
  reportAudits    ReportAudit[]
  reportFiles     ReportFile[]

  @@map("usuario")
}

// Reportes: plantillas, programaciones, auditoría y archivos generados
model ReportTemplate {
  id            Int              @id @default(autoincrement())
  name          String
  description   String?
  key           String           @unique
  defaultParams Json?            @map("default_params")
  createdAt     DateTime         @default(now()) @map("created_at")
  createdById   Int              @map("created_by_id")
  createdBy     Usuario          @relation(fields: [createdById], references: [id_usuario])
  schedules     ReportSchedule[]

  @@map("report_template")
}

model ReportSchedule {
  id          Int            @id @default(autoincrement())
  templateId  Int            @map("template_id")
  template    ReportTemplate @relation(fields: [templateId], references: [id])
  name        String
  cron        String
  recipients  String
  lastRunAt   DateTime?      @map("last_run_at")
  nextRunAt   DateTime?      @map("next_run_at")
  active      Boolean        @default(true)
  params      Json?
  createdAt   DateTime       @default(now()) @map("created_at")
  createdById Int            @map("created_by_id")
  createdBy   Usuario?       @relation(fields: [createdById], references: [id_usuario])

  @@map("report_schedule")
}

model ReportAudit {
  id          Int      @id @default(autoincrement())
  usuarioId   Int      @map("usuario_id")
  usuario     Usuario  @relation(fields: [usuarioId], references: [id_usuario])
  action      String
  templateKey String?  @map("template_key")
  params      Json?
  ip          String?
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("report_audit")
}

model ReportFile {
  id               Int      @id @default(autoincrement())
  templateKey      String?  @map("template_key")
  path             String
  filename         String
  mime             String
  size             Int
  createdBy        Int?     @map("created_by")
  createdAt        DateTime @default(now()) @map("created_at")
  createdByUsuario Usuario? @relation(fields: [createdBy], references: [id_usuario])

  @@map("report_file")
}

model Permiso {
  id_permiso     Int              @id @default(autoincrement())
  codigo         String           @unique @db.VarChar(100)
  nombre         String           @db.VarChar(150)
  descripcion    String?
  modulo         String           @db.VarChar(100)
  agrupador      String?          @db.VarChar(100)
  activo         Boolean          @default(true)
  creado_en      DateTime         @default(now())
  actualizado_en DateTime         @updatedAt
  moduloEntidad  Modulo           @relation(fields: [modulo], references: [clave])
  roles          RolPermiso[]
  usuarios       UsuarioPermiso[]

  @@index([modulo])
  @@map("permiso")
}

model RolPermiso {
  id_rol       Int
  id_permiso   Int
  creado_en    DateTime @default(now())
  asignado_por Int?
  descripcion  String?
  asignado     Usuario? @relation("RolPermisoAsignado", fields: [asignado_por], references: [id_usuario], onUpdate: NoAction)
  permiso      Permiso  @relation(fields: [id_permiso], references: [id_permiso], onDelete: Cascade)
  rol          Rol      @relation(fields: [id_rol], references: [id_rol], onDelete: Cascade)

  @@id([id_rol, id_permiso])
  @@map("rol_permiso")
}

model UsuarioPermiso {
  id_usuario     Int
  id_permiso     Int
  concedido      Boolean  @default(true)
  origen         String   @db.VarChar(20)
  comentario     String?
  actualizado_en DateTime @default(now()) @updatedAt
  permiso        Permiso  @relation(fields: [id_permiso], references: [id_permiso], onDelete: Cascade)
  usuario        Usuario  @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)

  @@id([id_usuario, id_permiso])
  @@map("usuario_permiso")
}

model Trabajador {
  id_trabajador                Int                     @id @default(autoincrement())
  id_usuario                   Int?                    @unique
  codigo_empleado              String                  @unique
  especialidad                 String                  @db.VarChar(100)
  nivel_experiencia            String                  @db.VarChar(20)
  tarifa_hora                  Decimal                 @default(0) @db.Decimal(8, 2)
  fecha_ingreso                DateTime                @default(now())
  activo                       Boolean                 @default(true)
  created_at                   DateTime                @default(now())
  updated_at                   DateTime                @updatedAt
  cargo                        String                  @db.VarChar(100)
  sueldo_mensual               Decimal?                @db.Decimal(10, 2)
  eliminado                    Boolean                 @default(false)
  id_persona                   Int                     @unique
  tareas_asignadas             Tarea[]
  persona                      Persona                 @relation(fields: [id_persona], references: [id_persona], onDelete: Cascade)
  usuario                      Usuario?                @relation(fields: [id_usuario], references: [id_usuario])
  ordenes_principales_directas Transaccion[]           @relation("TrabajadorPrincipal")
  ordenes_principales          TransaccionTrabajador[] @relation("Trabajador_Ordenes")

  @@map("trabajador")
}

model TransaccionTrabajador {
  id_transaccion Int
  id_trabajador  Int
  rol            String?     @db.VarChar(50)
  asignado_en    DateTime?   @default(now())
  trabajador     Trabajador  @relation("Trabajador_Ordenes", fields: [id_trabajador], references: [id_trabajador])
  transaccion    Transaccion @relation("Transaccion_Trabajador", fields: [id_transaccion], references: [id_transaccion])

  @@id([id_transaccion, id_trabajador])
  @@map("transaccion_trabajador")
}

model Categoria {
  id_categoria   Int        @id @default(autoincrement())
  nombre         String     @db.VarChar(100)
  estatus        Boolean    @default(true)
  fecha_registro DateTime   @default(now())
  productos      Producto[]

  @@map("categoria")
}

model UnidadMedida {
  id_unidad     Int        @id @default(autoincrement())
  nombre_unidad String     @db.VarChar(50)
  abreviatura   String     @db.VarChar(10)
  estatus       Boolean    @default(true)
  productos     Producto[]

  @@map("unidad_medida")
}

model Fabricante {
  id_fabricante     Int        @id @default(autoincrement())
  nombre_fabricante String     @db.VarChar(100)
  descripcion       String?
  estado            Boolean    @default(true)
  fecha_registro    DateTime   @default(now())
  productos         Producto[]

  @@map("fabricante")
}

model Producto {
  id_producto            Int                    @id @default(autoincrement())
  id_categoria           Int
  id_fabricante          Int
  id_unidad              Int
  tipo                   String                 @db.VarChar(20)
  codigo_producto        String                 @unique @db.VarChar(50)
  nombre                 String                 @db.VarChar(200)
  descripcion            String?
  stock                  Int                    @default(0)
  stock_minimo           Int                    @default(0)
  precio_compra          Decimal                @db.Decimal(10, 2)
  precio_venta           Decimal                @db.Decimal(10, 2)
  descuento              Decimal                @default(0) @db.Decimal(5, 2)
  oferta                 Boolean                @default(false)
  estatus                Boolean                @default(true)
  foto                   String?
  fecha_registro         DateTime               @default(now())
  compras_detalles       CompraDetalle[]
  ComprobanteDetalle     ComprobanteDetalle[]
  detalle_cotizaciones   DetalleCotizacion[]
  detalles_transaccion   DetalleTransaccion[]
  inventario_basico      Inventario?
  inventarios            InventarioProducto[]
  movimientos_basicos    Movimiento[]
  movimientos_inventario MovimientoInventario[]
  categoria              Categoria              @relation(fields: [id_categoria], references: [id_categoria])
  fabricante             Fabricante             @relation(fields: [id_fabricante], references: [id_fabricante])
  unidad_medida          UnidadMedida           @relation(fields: [id_unidad], references: [id_unidad])

  @@map("producto")
}

model Servicio {
  id_servicio          Int                  @id @default(autoincrement())
  codigo_servicio      String               @unique @db.VarChar(50)
  nombre               String               @db.VarChar(200)
  descripcion          String?
  es_general           Boolean              @default(false)
  id_marca             Int?
  id_modelo            Int?
  precio_base          Decimal              @db.Decimal(10, 2)
  descuento            Decimal              @default(0) @db.Decimal(5, 2)
  oferta               Boolean              @default(false)
  estatus              Boolean              @default(true)
  fecha_registro       DateTime             @default(now())
  tiempo_maximo        Int                  @default(1)
  tiempo_minimo        Int                  @default(1)
  unidad_tiempo        String               @default("minutos") @db.VarChar(10)
  ComprobanteDetalle   ComprobanteDetalle[]
  detalle_cotizacion   DetalleCotizacion[]
  detalles_transaccion DetalleTransaccion[]
  marca                Marca?               @relation(fields: [id_marca], references: [id_marca])
  modelo               Modelo?              @relation(fields: [id_modelo], references: [id_modelo])

  @@map("servicio")
}

model Marca {
  id_marca     Int        @id @default(autoincrement())
  nombre_marca String     @db.VarChar(50)
  estado       Boolean    @default(true)
  descripcion  String?
  modelos      Modelo[]
  servicios    Servicio[]

  @@map("marca")
}

model Modelo {
  id_modelo     Int        @id @default(autoincrement())
  id_marca      Int
  nombre_modelo String     @db.VarChar(50)
  estado        Boolean    @default(true)
  descripcion   String?
  marca         Marca      @relation(fields: [id_marca], references: [id_marca])
  servicios     Servicio[]
  vehiculos     Vehiculo[]

  @@map("modelo")
}

model Vehiculo {
  id_vehiculo           Int                   @id @default(autoincrement())
  id_cliente            Int
  id_modelo             Int
  placa                 String                @unique @db.VarChar(10)
  tipo                  String                @db.VarChar(50)
  año                  Int
  tipo_combustible      String                @db.VarChar(30)
  transmision           String                @db.VarChar(30)
  numero_chasis         String?               @db.VarChar(50)
  numero_motor          String?               @db.VarChar(50)
  observaciones         String?
  imagen                String?
  estado                Boolean               @default(true)
  cotizaciones          Cotizacion[]
  mantenimientos        Mantenimiento[]
  transaccion_vehiculos TransaccionVehiculo[]
  cliente               Cliente               @relation(fields: [id_cliente], references: [id_cliente])
  modelo                Modelo                @relation(fields: [id_modelo], references: [id_modelo])

  @@map("vehiculo")
}

model Transaccion {
  id_transaccion           Int                     @id @default(autoincrement())
  id_persona               Int
  id_usuario               Int
  tipo_transaccion         String                  @db.VarChar(50)
  tipo_comprobante         String                  @db.VarChar(50)
  serie_comprobante        String?                 @db.VarChar(10)
  numero_comprobante       String?                 @db.VarChar(20)
  codigo_transaccion       String                  @unique @db.VarChar(50)
  fecha                    DateTime                @default(now())
  descuento                Decimal                 @default(0) @db.Decimal(10, 2)
  impuesto                 Decimal                 @default(0) @db.Decimal(10, 2)
  porcentaje               Decimal                 @default(0) @db.Decimal(5, 2)
  total                    Decimal                 @db.Decimal(10, 2)
  cantidad_pago            Decimal                 @default(0) @db.Decimal(10, 2)
  observaciones            String?
  estatus                  String                  @default("activo") @db.VarChar(20)
  estado_orden             String                  @default("pendiente") @db.VarChar(30)
  prioridad                String                  @default("media") @db.VarChar(20)
  created_at               DateTime                @default(now())
  updated_at               DateTime                @updatedAt
  entregado_por            Int?
  estado_pago              String                  @default("pendiente") @db.VarChar(20)
  fecha_entrega            DateTime?
  fecha_fin_estimada       DateTime?
  fecha_fin_real           DateTime?
  fecha_inicio             DateTime?
  id_trabajador_principal  Int?
  duracion_max             Int?
  duracion_min             Int?
  unidad_tiempo            String?                 @db.VarChar(10)
  fecha_cierre             DateTime?
  comprobantes             Comprobante?
  detalles_transaccion     DetalleTransaccion[]
  feedback                 Feedback[]
  mantenimiento            Mantenimiento[]         @relation("OrdenMantenimiento")
  historial                OrdenHistorial[]
  pagos                    Pago[]
  reservas_inventario      ReservaInventario[]
  usuario_entrega          Usuario?                @relation("EntregaUsuario", fields: [entregado_por], references: [id_usuario])
  persona                  Persona                 @relation(fields: [id_persona], references: [id_persona])
  trabajador_principal     Trabajador?             @relation("TrabajadorPrincipal", fields: [id_trabajador_principal], references: [id_trabajador])
  usuario                  Usuario                 @relation(fields: [id_usuario], references: [id_usuario])
  transaccion_proveedores  TransaccionProveedor[]
  transaccion_trabajadores TransaccionTrabajador[] @relation("Transaccion_Trabajador")
  transaccion_vehiculos    TransaccionVehiculo[]

  @@index([fecha_cierre])
  @@map("transaccion")
}

model Pago {
  id_pago          Int         @id @default(autoincrement())
  id_transaccion   Int
  tipo_pago        String      @db.VarChar(30)
  monto            Decimal     @db.Decimal(10, 2)
  numero_operacion String?     @db.VarChar(50)
  fecha_pago       DateTime    @default(now())
  registrado_por   Int
  observaciones    String?
  transaccion      Transaccion @relation(fields: [id_transaccion], references: [id_transaccion])
  usuario_registro Usuario     @relation("PagoUsuario", fields: [registrado_por], references: [id_usuario])

  @@map("pago")
}

model FacturacionConfig {
  id_config                    Int      @id @default(1)
  afecta_igv                   Boolean  @default(true)
  igv_porcentaje               Decimal  @default(0.18) @db.Decimal(5, 4)
  serie_boleta_default         String   @db.VarChar(10)
  serie_factura_default        String   @db.VarChar(10)
  precios_incluyen_igv_default Boolean  @default(true)
  moneda_default               String   @default("PEN") @db.VarChar(3)
  created_at                   DateTime @default(now())
  updated_at                   DateTime @updatedAt

  @@map("facturacion_config")
}

model FacturacionSerie {
  id_facturacion_serie Int             @id @default(autoincrement())
  tipo                 TipoComprobante
  serie                String          @db.VarChar(10)
  correlativo_actual   Int             @default(0)
  activo               Boolean         @default(true)
  descripcion          String?         @db.VarChar(150)
  created_at           DateTime        @default(now())
  updated_at           DateTime        @updatedAt
  comprobantes         Comprobante[]

  @@unique([tipo, serie])
  @@map("facturacion_serie")
}

model Comprobante {
  id_comprobante            Int                   @id @default(autoincrement())
  id_facturacion_serie      Int?
  tipo                      TipoComprobante
  serie                     String                @db.VarChar(10)
  numero                    Int
  origen_tipo               OrigenComprobante
  origen_id                 Int
  estado_pago               String                @default("pendiente") @db.VarChar(20)
  codigo                    String?               @db.VarChar(30)
  estado                    EstadoComprobante     @default(BORRADOR)
  incluye_igv               Boolean               @default(true)
  moneda                    String                @default("PEN") @db.VarChar(3)
  subtotal                  Decimal               @db.Decimal(12, 2)
  igv                       Decimal               @db.Decimal(12, 2)
  total                     Decimal               @db.Decimal(12, 2)
  receptor_nombre           String                @db.VarChar(200)
  receptor_documento        String                @db.VarChar(20)
  receptor_direccion        String?               @db.VarChar(200)
  descripcion               String?
  notas                     String?
  precios_incluyen_igv      Boolean               @default(true)
  fecha_emision             DateTime?
  pdf_url                   String?
  xml_url                   String?
  override_tipo_comprobante TipoComprobante?
  motivo_override           String?
  creado_en                 DateTime              @default(now())
  actualizado_en            DateTime              @updatedAt
  creado_por                Int
  actualizado_por           Int?
  id_persona                Int
  id_empresa_persona        Int?
  id_cliente                Int
  id_cotizacion             Int?                  @unique
  id_transaccion            Int?                  @unique
  actualizado_por_usuario   Usuario?              @relation("ComprobanteActualizadoPor", fields: [actualizado_por], references: [id_usuario])
  creado_por_usuario        Usuario               @relation("ComprobanteCreadoPor", fields: [creado_por], references: [id_usuario])
  cliente                   Cliente               @relation(fields: [id_cliente], references: [id_cliente])
  cotizacion                Cotizacion?           @relation(fields: [id_cotizacion], references: [id_cotizacion])
  empresa                   EmpresaPersona?       @relation(fields: [id_empresa_persona], references: [id_empresa_persona])
  serie_rel                 FacturacionSerie?     @relation(fields: [id_facturacion_serie], references: [id_facturacion_serie])
  persona                   Persona               @relation(fields: [id_persona], references: [id_persona])
  transaccion               Transaccion?          @relation(fields: [id_transaccion], references: [id_transaccion])
  bitacoras                 ComprobanteBitacora[]
  detalles                  ComprobanteDetalle[]
  venta                     Venta?

  @@unique([serie, numero])
  @@unique([origen_tipo, origen_id])
  @@map("comprobante")
}

model Venta {
  id_venta         Int              @id @default(autoincrement())
  id_comprobante   Int              @unique
  fecha            DateTime         @default(now())
  total            Decimal          @db.Decimal(12, 2)
  total_pagado     Decimal          @default(0) @db.Decimal(12, 2)
  saldo            Decimal          @default(0) @db.Decimal(12, 2)
  metodo_principal MetodoPagoVenta?
  estado_pago      EstadoPagoVenta  @default(pendiente)
  metadata         Json?
  creado_en        DateTime         @default(now())
  actualizado_en   DateTime         @updatedAt
  comprobante      Comprobante      @relation(fields: [id_comprobante], references: [id_comprobante], onDelete: Cascade)
  pagos            VentaPago[]

  @@index([fecha])
  @@index([metodo_principal])
  @@index([estado_pago])
  @@map("venta")
}

model VentaPago {
  id_venta_pago  Int             @id @default(autoincrement())
  id_venta       Int
  metodo         MetodoPagoVenta
  monto          Decimal         @db.Decimal(12, 2)
  referencia     String?         @db.VarChar(120)
  fecha_pago     DateTime        @default(now())
  notas          String?
  registrado_por Int
  venta          Venta           @relation(fields: [id_venta], references: [id_venta], onDelete: Cascade)
  usuario        Usuario         @relation(fields: [registrado_por], references: [id_usuario])

  @@index([id_venta, fecha_pago])
  @@map("venta_pago")
}

model ComprobanteDetalle {
  id_comprobante_detalle Int                 @id @default(autoincrement())
  id_comprobante         Int
  tipo_item              TipoItemComprobante
  descripcion            String              @db.VarChar(200)
  cantidad               Decimal             @db.Decimal(12, 3)
  unidad_medida          String?             @db.VarChar(10)
  precio_unitario        Decimal             @db.Decimal(12, 2)
  descuento              Decimal             @default(0) @db.Decimal(12, 2)
  subtotal               Decimal             @db.Decimal(12, 2)
  igv                    Decimal             @db.Decimal(12, 2)
  total                  Decimal             @db.Decimal(12, 2)
  id_producto            Int?
  id_servicio            Int?
  metadata               Json?
  comprobante            Comprobante         @relation(fields: [id_comprobante], references: [id_comprobante], onDelete: Cascade)
  producto               Producto?           @relation(fields: [id_producto], references: [id_producto])
  servicio               Servicio?           @relation(fields: [id_servicio], references: [id_servicio])

  @@map("comprobante_detalle")
}

model ComprobanteBitacora {
  id_comprobante_bitacora Int         @id @default(autoincrement())
  id_comprobante          Int
  id_usuario              Int
  accion                  String      @db.VarChar(50)
  descripcion             String?
  metadata                Json?
  created_at              DateTime    @default(now())
  comprobante             Comprobante @relation(fields: [id_comprobante], references: [id_comprobante], onDelete: Cascade)
  usuario                 Usuario     @relation(fields: [id_usuario], references: [id_usuario])

  @@map("comprobante_bitacora")
}

model DetalleTransaccion {
  id_detalle_transaccion       Int                 @id @default(autoincrement())
  id_transaccion               Int
  id_producto                  Int?
  cantidad                     Int
  precio                       Decimal             @db.Decimal(10, 2)
  descuento                    Decimal             @default(0) @db.Decimal(10, 2)
  total                        Decimal             @db.Decimal(10, 2)
  estatus                      Boolean             @default(true)
  id_servicio                  Int?
  id_detalle_servicio_asociado Int?                @unique
  servicio_asociado            DetalleTransaccion? @relation("ProductoAsociadoServicio", fields: [id_detalle_servicio_asociado], references: [id_detalle_transaccion])
  productos_asociados          DetalleTransaccion? @relation("ProductoAsociadoServicio")
  producto                     Producto?           @relation(fields: [id_producto], references: [id_producto])
  servicio                     Servicio?           @relation(fields: [id_servicio], references: [id_servicio])
  transaccion                  Transaccion         @relation(fields: [id_transaccion], references: [id_transaccion], onDelete: Cascade)
  reservas                     ReservaInventario[]
  tareas                       Tarea[]

  @@map("detalle_transaccion")
}

model Tarea {
  id_tarea               Int                @id @default(autoincrement())
  id_detalle_transaccion Int
  estado                 String             @default("pendiente") @db.VarChar(30)
  fecha_inicio           DateTime?
  fecha_fin              DateTime?
  tiempo_estimado        Int?
  tiempo_real            Int?
  created_at             DateTime           @default(now())
  id_trabajador          Int?
  notas_trabajador       String?
  updated_at             DateTime           @updatedAt
  detalle_transaccion    DetalleTransaccion @relation(fields: [id_detalle_transaccion], references: [id_detalle_transaccion])
  trabajador             Trabajador?        @relation(fields: [id_trabajador], references: [id_trabajador])

  @@map("tarea")
}

model TransaccionProveedor {
  id_transaccion Int
  id_proveedor   Int
  proveedor      Proveedor   @relation(fields: [id_proveedor], references: [id_proveedor])
  transaccion    Transaccion @relation(fields: [id_transaccion], references: [id_transaccion])

  @@id([id_transaccion, id_proveedor])
  @@map("transaccion_proveedor")
}

model TransaccionVehiculo {
  id_transaccion     Int
  id_vehiculo        Int
  id_usuario         Int
  nivel_combustible  String?     @db.VarChar(20)
  kilometraje_millas Int?
  descripcion        String?
  transaccion        Transaccion @relation(fields: [id_transaccion], references: [id_transaccion])
  usuario            Usuario     @relation(fields: [id_usuario], references: [id_usuario])
  vehiculo           Vehiculo    @relation(fields: [id_vehiculo], references: [id_vehiculo])

  @@id([id_transaccion, id_vehiculo])
  @@map("transaccion_vehiculo")
}

model Almacen {
  id_almacen     Int                  @id @default(autoincrement())
  nombre         String               @db.VarChar(100)
  descripcion    String?
  direccion      String?
  activo         Boolean              @default(true)
  creado_en      DateTime             @default(now())
  actualizado_en DateTime             @updatedAt
  ubicaciones    AlmacenUbicacion[]
  inventarios    InventarioProducto[]

  @@map("almacen")
}

model AlmacenUbicacion {
  id_almacen_ubicacion Int                  @id @default(autoincrement())
  id_almacen           Int
  codigo               String               @unique @db.VarChar(50)
  descripcion          String?
  activo               Boolean              @default(true)
  creado_en            DateTime             @default(now())
  actualizado_en       DateTime             @updatedAt
  almacen              Almacen              @relation(fields: [id_almacen], references: [id_almacen])
  inventarios          InventarioProducto[]

  @@map("almacen_ubicacion")
}

model InventarioProducto {
  id_inventario_producto Int                    @id @default(autoincrement())
  id_producto            Int
  id_almacen             Int
  id_almacen_ubicacion   Int?
  stock_disponible       Decimal                @default(0) @db.Decimal(14, 4)
  stock_comprometido     Decimal                @default(0) @db.Decimal(14, 4)
  stock_minimo           Decimal                @default(0) @db.Decimal(14, 4)
  stock_maximo           Decimal?               @db.Decimal(14, 4)
  costo_promedio         Decimal                @default(0) @db.Decimal(14, 4)
  creado_en              DateTime               @default(now())
  actualizado_en         DateTime               @updatedAt
  es_critico             Boolean                @default(false)
  almacen                Almacen                @relation(fields: [id_almacen], references: [id_almacen])
  ubicacion              AlmacenUbicacion?      @relation(fields: [id_almacen_ubicacion], references: [id_almacen_ubicacion])
  producto               Producto               @relation(fields: [id_producto], references: [id_producto])
  movimientos            MovimientoInventario[]
  reservas               ReservaInventario[]

  @@unique([id_producto, id_almacen, id_almacen_ubicacion])
  @@index([es_critico])
  @@map("inventario_producto")
}

model OrdenHistorial {
  id_orden_historial Int         @id @default(autoincrement())
  orden_id           Int
  old_status         String?     @db.VarChar(30)
  new_status         String      @db.VarChar(30)
  nota               String?
  created_at         DateTime    @default(now())
  changed_by         Int?
  usuario            Usuario?    @relation("OrdenHistorialUsuario", fields: [changed_by], references: [id_usuario])
  orden              Transaccion @relation(fields: [orden_id], references: [id_transaccion], onDelete: Cascade)

  @@index([orden_id, created_at], map: "orden_historial_orden_created_idx")
  @@map("orden_historial")
}

model Mantenimiento {
  id_mantenimiento   Int                      @id @default(autoincrement())
  codigo             String                   @unique @db.VarChar(50)
  id_vehiculo        Int
  id_cliente         Int?
  id_transaccion     Int?
  titulo             String?                  @db.VarChar(150)
  descripcion        String?
  estado             String                   @default("planificado") @db.VarChar(30)
  prioridad          String                   @default("media") @db.VarChar(20)
  fecha_programada   DateTime
  fecha_inicio       DateTime?
  fecha_realizada    DateTime?
  motivo_cancelacion String?
  creado_en          DateTime                 @default(now())
  actualizado_en     DateTime                 @default(now()) @updatedAt
  cliente            Cliente?                 @relation(fields: [id_cliente], references: [id_cliente])
  orden              Transaccion?             @relation("OrdenMantenimiento", fields: [id_transaccion], references: [id_transaccion])
  vehiculo           Vehiculo                 @relation(fields: [id_vehiculo], references: [id_vehiculo])
  historial          MantenimientoHistorial[]

  @@index([fecha_programada])
  @@index([estado])
  @@map("mantenimiento")
}

model MantenimientoHistorial {
  id_mantenimiento_historial Int           @id @default(autoincrement())
  mantenimiento_id           Int
  old_fecha                  DateTime?
  new_fecha                  DateTime?
  reason                     String?
  created_at                 DateTime      @default(now())
  changed_by                 Int?
  usuario                    Usuario?      @relation("MantenimientoHistorialUsuario", fields: [changed_by], references: [id_usuario])
  mantenimiento              Mantenimiento @relation(fields: [mantenimiento_id], references: [id_mantenimiento], onDelete: Cascade)

  @@index([mantenimiento_id, created_at], map: "mantenimiento_historial_mantenimiento_created_idx")
  @@map("mantenimiento_historial")
}

model Feedback {
  id_feedback Int         @id @default(autoincrement())
  orden_id    Int
  score       Int
  comentario  String?
  creado_en   DateTime    @default(now())
  orden       Transaccion @relation(fields: [orden_id], references: [id_transaccion], onDelete: Cascade)

  @@index([orden_id])
  @@map("feedback")
}

model IndicadorCache {
  id_indicador_cache Int       @id @default(autoincrement())
  indicador          String    @db.VarChar(60)
  hash               String    @unique @db.VarChar(64)
  rango_desde        DateTime
  rango_hasta        DateTime
  parametros         Json?
  payload            Json
  computed_at        DateTime  @default(now())
  expires_at         DateTime?

  @@index([indicador, rango_desde, rango_hasta], map: "indicador_cache_indicador_rango_idx")
  @@map("indicador_cache")
}

model MovimientoInventario {
  id_movimiento_inventario Int                      @id @default(autoincrement())
  tipo                     MovimientoTipo
  id_producto              Int
  id_inventario_producto   Int
  cantidad                 Decimal                  @db.Decimal(14, 4)
  costo_unitario           Decimal                  @db.Decimal(14, 4)
  referencia_origen        String?                  @db.VarChar(100)
  origen_tipo              MovimientoOrigen?
  observaciones            String?
  id_usuario               Int
  fecha                    DateTime                 @default(now())
  bitacoras                BitacoraInventario[]
  inventario               InventarioProducto       @relation(fields: [id_inventario_producto], references: [id_inventario_producto])
  producto                 Producto                 @relation(fields: [id_producto], references: [id_producto])
  usuario                  Usuario                  @relation(fields: [id_usuario], references: [id_usuario])
  transferencia_envio      MovimientoTransferencia? @relation("TransferenciaEnvio")
  transferencia_recepcion  MovimientoTransferencia? @relation("TransferenciaRecepcion")

  @@map("movimiento_inventario")
}

model MovimientoTransferencia {
  id_movimiento_transferencia Int                  @id @default(autoincrement())
  id_movimiento_envio         Int                  @unique
  id_movimiento_recepcion     Int                  @unique
  estado                      TransferenciaEstado  @default(PENDIENTE_RECEPCION)
  creado_en                   DateTime             @default(now())
  actualizado_en              DateTime             @updatedAt
  movimiento_envio            MovimientoInventario @relation("TransferenciaEnvio", fields: [id_movimiento_envio], references: [id_movimiento_inventario])
  movimiento_recepcion        MovimientoInventario @relation("TransferenciaRecepcion", fields: [id_movimiento_recepcion], references: [id_movimiento_inventario])

  @@map("movimiento_transferencia")
}

model BitacoraInventario {
  id_bitacora_inventario Int                  @id @default(autoincrement())
  id_movimiento          Int
  id_usuario             Int
  accion                 String               @db.VarChar(100)
  descripcion            String?
  metadata               Json?
  creado_en              DateTime             @default(now())
  movimiento             MovimientoInventario @relation(fields: [id_movimiento], references: [id_movimiento_inventario], onDelete: Cascade)
  usuario                Usuario              @relation(fields: [id_usuario], references: [id_usuario])

  @@map("bitacora_inventario")
}

model ReservaInventario {
  id_reserva_inventario  Int                 @id @default(autoincrement())
  id_inventario_producto Int
  id_transaccion         Int?
  id_detalle_transaccion Int?
  cantidad               Decimal             @db.Decimal(14, 4)
  estado                 ReservaEstado       @default(PENDIENTE)
  motivo                 String?
  metadata               Json?
  creado_en              DateTime            @default(now())
  actualizado_en         DateTime            @updatedAt
  detalle_transaccion    DetalleTransaccion? @relation(fields: [id_detalle_transaccion], references: [id_detalle_transaccion])
  inventario             InventarioProducto  @relation(fields: [id_inventario_producto], references: [id_inventario_producto])
  transaccion            Transaccion?        @relation(fields: [id_transaccion], references: [id_transaccion])

  @@map("reserva_inventario")
}

model Inventario {
  id_inventario      Int      @id @default(autoincrement())
  id_producto        Int      @unique
  stock_disponible   Decimal  @default(0) @db.Decimal(14, 4)
  stock_comprometido Decimal  @default(0) @db.Decimal(14, 4)
  costo_promedio     Decimal  @default(0) @db.Decimal(14, 4)
  creado_en          DateTime @default(now())
  actualizado_en     DateTime @updatedAt
  producto           Producto @relation(fields: [id_producto], references: [id_producto])

  @@map("inventario")
}

model Compra {
  id_compra      Int             @id @default(autoincrement())
  id_proveedor   Int
  fecha          DateTime        @default(now())
  total          Decimal         @default(0) @db.Decimal(14, 4)
  estado         CompraEstado    @default(RECIBIDO)
  creado_por     Int
  creado_en      DateTime        @default(now())
  actualizado_en DateTime        @updatedAt
  usuario        Usuario         @relation(fields: [creado_por], references: [id_usuario])
  proveedor      Proveedor       @relation(fields: [id_proveedor], references: [id_proveedor])
  detalles       CompraDetalle[]

  @@map("compra")
}

model CompraDetalle {
  id_compra_detalle Int      @id @default(autoincrement())
  id_compra         Int
  id_producto       Int
  cantidad          Decimal  @db.Decimal(14, 4)
  precio_unitario   Decimal  @db.Decimal(14, 4)
  subtotal          Decimal  @db.Decimal(14, 4)
  compra            Compra   @relation(fields: [id_compra], references: [id_compra], onDelete: Cascade)
  producto          Producto @relation(fields: [id_producto], references: [id_producto])

  @@unique([id_compra, id_producto])
  @@map("compra_detalle")
}

model Movimiento {
  id_movimiento  Int                  @id @default(autoincrement())
  tipo           MovimientoBasicoTipo
  id_producto    Int
  cantidad       Decimal              @db.Decimal(14, 4)
  costo_unitario Decimal?             @db.Decimal(14, 4)
  referencia     String?              @db.VarChar(120)
  id_usuario     Int
  creado_en      DateTime             @default(now())
  producto       Producto             @relation(fields: [id_producto], references: [id_producto])
  usuario        Usuario              @relation(fields: [id_usuario], references: [id_usuario])

  @@index([id_producto])
  @@map("movimiento")
}

model Bitacora {
  id_bitacora Int      @id @default(autoincrement())
  id_usuario  Int
  accion      String   @db.VarChar(100)
  descripcion String?
  fecha_hora  DateTime @default(now())
  tabla       String?  @db.VarChar(50)
  ip_publica  String?  @db.VarChar(45)
  usuario     Usuario  @relation(fields: [id_usuario], references: [id_usuario])

  @@map("bitacora")
}

model Configuracion {
  id_conf              Int       @id @default(autoincrement())
  nombre_empresa       String    @db.VarChar(200)
  direccion            String?
  telefono             String?   @db.VarChar(15)
  celular              String?   @db.VarChar(15)
  correo               String?   @db.VarChar(100)
  rtn                  String?   @db.VarChar(20)
  isv                  String?   @db.VarChar(20)
  precio_dolar         Decimal?  @db.Decimal(10, 4)
  cai                  String?   @db.VarChar(50)
  cantidad_facturas    Int?
  numero_inicial       Int?
  numero_final         Int?
  fecha_limite_emision DateTime?
  imagen_logo          String?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt

  @@map("configuracion")
}

enum TipoDocumento {
  DNI
  RUC
  CE
  PASAPORTE
}

enum TipoComprobante {
  BOLETA
  FACTURA
}

enum EstadoComprobante {
  BORRADOR
  EMITIDO
  ANULADO
  OBSERVADO
}

enum TipoItemComprobante {
  PRODUCTO
  SERVICIO
}

enum OrigenComprobante {
  COTIZACION
  ORDEN
}

enum EstadoPagoVenta {
  pendiente
  parcial
  pagado
}

enum MetodoPagoVenta {
  EFECTIVO
  TARJETA
  APP_MOVIL
  TRANSFERENCIA
  OTRO
}

enum MovimientoTipo {
  INGRESO
  SALIDA
  AJUSTE_POSITIVO
  AJUSTE_NEGATIVO
  TRANSFERENCIA_ENVIO
  TRANSFERENCIA_RECEPCION
}

enum MovimientoOrigen {
  COMPRA
  ORDEN_TRABAJO
  FACTURACION
  AJUSTE_MANUAL
  TRANSFERENCIA
  OTRO
}

enum TransferenciaEstado {
  PENDIENTE_RECEPCION
  COMPLETADA
  ANULADA
}

enum ReservaEstado {
  PENDIENTE
  CONFIRMADA
  LIBERADA
  CANCELADA
}

enum MovimientoBasicoTipo {
  INGRESO
  SALIDA
  AJUSTE
}

enum CompraEstado {
  PENDIENTE
  RECIBIDO
  ANULADO
}
